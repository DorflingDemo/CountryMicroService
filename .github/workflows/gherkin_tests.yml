name: Run Gherkin Tests (TypeScript)

on:
  push:
    branches: [ main ] # Or your primary branch
  pull_request:
    branches: [ main ] # Or your primary branch

jobs:
  test:
    runs-on: ubuntu-latest # Use a standard GitHub-hosted Linux runner
    steps:
    - name: Check out code
      uses: actions/checkout@v4 # Action to get your repository code

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18' # Choose a suitable LTS Node.js version

    - name: Install dependencies
      run: npm install # Installs dependencies listed in package.json

    - name: Build TypeScript
      run: npm run build # Compile TypeScript to JavaScript

    - name: Verify build output # <-- ADD THIS STEP
      run: ls -R dist # List contents of dist directory recursively

    - name: Start server in background
      run: npm start & # Start the server using the script defined in package.json, run in background
      # The '&' runs the command in the background

    - name: Wait for server to be ready
      run: npx wait-on http://localhost:3000/countries -t 15000 # Wait for the /countries endpoint, timeout after 15s
      # wait-on was installed via package.json devDependencies

    - name: Run Cucumber tests
      run: npx cucumber-js features/**/*.feature -c cucumber.js # Explicitly specify the config file
      # This command tells cucumber-js to find .feature files using the specified config.
      # The config points to the compiled JS step definitions.
      # IMPORTANT: This step currently ASSUMES the microservice API is running and accessible.
      # We will need to add steps later to either start the service or configure the target URL.
